<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>InsightAtlas Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f4f4f4;
      color: #333;
      display: flex; flex-direction: column; align-items: center;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 15px;
      width: 100%;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      position: relative;
    }
    #settingsBtn {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 2em;
      cursor: pointer;
    }
    #settingsMenu {
      display: none;
      position: absolute;
      top: 60px;
      right: 15px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 100;
      width: 220px;
    }
    #settingsMenu label {
      display: block;
      margin-top: 10px;
    }
    main {
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .book-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    .book-item {
      width: 140px;
      text-align: center;
      cursor: pointer;
    }
    .book-item img {
      width: 100%;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    .reader {
      display: none;
      margin-top: 20px;
    }
    .controls button {
      padding: 14px;
      margin: 10px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #4a90e2;
      color: white;
      width: 120px;
    }
    .controls button:hover {
      background: #357abd;
    }
    #pageNumbers {
      margin-top: 15px;
    }
    .page-btn {
      margin: 5px;
      padding: 8px 12px;
      border: 1px solid #4a90e2;
      border-radius: 6px;
      background: #e1f0ff;
      cursor: pointer;
    }
    .page-btn.active {
      background: #4a90e2;
      color: white;
    }
    /* Dark Mode */
    body.dark {
      background: #222;
      color: #eee;
    }
    body.dark main {
      background: #333;
      color: #eee;
    }
    body.dark #settingsMenu {
      background: #444;
      color: #fff;
    }
    body.dark .page-btn {
      background: #555;
      color: white;
    }
    body.dark .controls button {
      background: #666;
    }
  </style>
</head>
<body>
  <header>
    InsightAtlas Reader
    <span id="settingsBtn">⚙️</span>
    <div id="settingsMenu">
      <label>Theme:
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </label>
      <label>Voice:
        <select id="voiceGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </label>
      <label>Accent:
        <select id="voiceAccent">
          <option value="en-GB">UK English</option>
          <option value="en-US">US English</option>
          <option value="en-AU">Australian</option>
          <option value="en-IN">Indian</option>
        </select>
      </label>
    </div>
  </header>

  <main>
    <h2>Available Books</h2>
    <div class="book-list" id="bookList"></div>

    <div class="reader" id="reader">
      <h2 id="bookTitle"></h2>
      <div id="bookContent" style="white-space: pre-wrap; margin-top:15px; font-size:1.2em;"></div>
      <div class="controls">
        <button onclick="play()">▶️ Play</button>
        <button onclick="pause()">⏸️ Pause</button>
        <button onclick="resume()">⏯️ Resume</button>
        <button onclick="stop()">⏹️ Stop</button>
      </div>
      <div id="pageNumbers"></div>
    </div>
  </main>

  <script>
    let books = JSON.parse(localStorage.getItem("books")) || [];
    let currentBook = null;
    let currentPage = 0;
    let utterance = null;
    let pausedText = "";
    let voices = [];
    let selectedVoice = null;

    function renderBooks() {
      const list = document.getElementById("bookList");
      list.innerHTML = "";
      books.forEach((book, index) => {
        const div = document.createElement("div");
        div.className = "book-item";
        div.innerHTML = `<img src="${book.cover}" alt="cover"><br>${book.title}`;
        div.onclick = () => openBook(index);
        list.appendChild(div);
      });
    }

    function openBook(index) {
      currentBook = books[index];
      document.getElementById("bookTitle").textContent = currentBook.title;

      // Extract text from PDF
      const pdfData = atob(currentBook.pdf.split(",")[1]);
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

      const loadingTask = pdfjsLib.getDocument({data: pdfData});
      loadingTask.promise.then(pdf => {
        currentBook.pages = [];
        let pagePromises = [];
        for (let i=1; i<=pdf.numPages; i++) {
          pagePromises.push(pdf.getPage(i).then(page => {
            return page.getTextContent().then(tc => 
              tc.items.map(item => item.str).join(" ")
            );
          }));
        }
        Promise.all(pagePromises).then(texts => {
          currentBook.pages = texts;
          currentPage = 0;
          showPage(0);
          document.getElementById("reader").style.display = "block";
        });
      });
    }

    function showPage(num) {
      currentPage = num;
      document.getElementById("bookContent").textContent = currentBook.pages[num];
      renderPageButtons();
    }

    function renderPageButtons() {
      const container = document.getElementById("pageNumbers");
      container.innerHTML = "";
      currentBook.pages.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.textContent = i+1;
        btn.className = "page-btn" + (i===currentPage ? " active":"");
        btn.onclick = () => showPage(i);
        container.appendChild(btn);
      });
    }

    function play() {
      stop();
      const text = currentBook.pages[currentPage];
      utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = selectedVoice || voices[0];
      utterance.rate = 0.9;
      utterance.onend = () => {
        if (currentPage < currentBook.pages.length-1) {
          showPage(currentPage+1);
          play();
        }
      };
      speechSynthesis.speak(utterance);
    }

    function pause() {
      speechSynthesis.pause();
    }

    function resume() {
      speechSynthesis.resume();
    }

    function stop() {
      speechSynthesis.cancel();
    }

    function toggleSettings() {
      const menu = document.getElementById("settingsMenu");
      menu.style.display = (menu.style.display === "block") ? "none":"block";
    }

    function loadVoices() {
      voices = speechSynthesis.getVoices();
      applyVoiceSettings();
    }

    function applyVoiceSettings() {
      const gender = localStorage.getItem("voiceGender") || "male";
      const accent = localStorage.getItem("voiceAccent") || "en-GB";
      selectedVoice = voices.find(v => v.lang.startsWith(accent) && v.name.toLowerCase().includes(gender)) || voices.find(v => v.lang.startsWith(accent)) || voices[0];
      document.getElementById("voiceGender").value = gender;
      document.getElementById("voiceAccent").value = accent;
    }

    // Settings
    document.getElementById("settingsBtn").onclick = toggleSettings;
    document.getElementById("themeSelect").onchange = e => {
      const theme = e.target.value;
      document.body.className = theme === "dark" ? "dark" : "";
      localStorage.setItem("theme", theme);
    };
    document.getElementById("voiceGender").onchange = e => {
      localStorage.setItem("voiceGender", e.target.value);
      applyVoiceSettings();
    };
    document.getElementById("voiceAccent").onchange = e => {
      localStorage.setItem("voiceAccent", e.target.value);
      applyVoiceSettings();
    };

    // Init
    renderBooks();
    loadVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
      document.getElementById("themeSelect").value = "dark";
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</body>
</html>
