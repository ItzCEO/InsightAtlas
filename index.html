<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightAtlas - The Main Reality Of Life</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... existing styles ... */
        
        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: background-color 0.3s ease;
            padding-bottom: 80px;
            min-height: 100vh;
            /* CHANGED: Reduced brightness from 5.5 to 2.5 */
            filter: brightness(2.5);
        }
        
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            /* CHANGED: Reduced brightness from 1.1 to 2.5 */
            filter: brightness(2.5);
        }
        
        /* ... existing styles ... */
        
        /* OTP Display - Enhanced visibility */
        .otp-display {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--light-card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 10000;
            max-width: 250px;
            /* Added contrast for better visibility */
            border: 2px solid var(--accent);
        }
        
        .dark-mode .otp-display {
            background-color: var(--dark-card);
            /* Added border for dark mode visibility */
            border: 2px solid var(--secondary);
        }
        
        .otp-display-content {
            text-align: center;
        }
        
        .otp-display-code {
            font-size: 28px; /* Increased size */
            font-weight: 800; /* Bolder font */
            margin: 10px 0;
            letter-spacing: 5px;
            /* Changed to solid color for better contrast */
            color: var(--primary-dark);
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .dark-mode .otp-display-code {
            color: var(--secondary); /* High contrast for dark mode */
        }
        
        .otp-display-timer {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600; /* Bolder font */
        }
        
        /* ... existing styles ... */
    </style>
    <!-- ... rest of head ... -->
</head>
<body>
    <!-- ... existing HTML ... -->

    <script>
        // User Account Management
        const USER_ACCOUNTS_KEY = 'insightAtlasAccounts';
        const CURRENT_USER_KEY = 'insightAtlasCurrentUser';
        const PURCHASED_BOOKS_KEY = 'insightAtlasPurchasedBooks';
        const APP_LANGUAGE_KEY = 'insightAtlasAppLanguage';
        
        // Book Management
        const BOOKS_KEY = 'insightAtlasBooks';
        const CURRENT_BOOK_ID = 'main-reality';
        
        // DOM Elements
        // ... existing DOM elements ...
        
        // NEW: Password reset state
        let resetEmail = '';

        // Load user accounts from localStorage
        let userAccounts = JSON.parse(localStorage.getItem(USER_ACCOUNTS_KEY)) || [];
        let currentUser = JSON.parse(localStorage.getItem(CURRENT_USER_KEY)) || null;
        let purchasedBooks = JSON.parse(localStorage.getItem(PURCHASED_BOOKS_KEY)) || [];
        let appLanguage = localStorage.getItem(APP_LANGUAGE_KEY) || 'en';
        let books = JSON.parse(localStorage.getItem(BOOKS_KEY)) || [];
        
        // Check if user is logged in
        if (currentUser) {
            showApp();
            updateUserAvatar();
            
            // Redirect to profile if new user
            if (currentUser.isNew) {
                showProfileView();
            }
        }
        
        // ... existing functions ...

        // NEW: Check if username is available
        function isUsernameAvailable(username) {
            return !userAccounts.some(user => user.username.toLowerCase() === username.toLowerCase());
        }

        // NEW: Save user account
        function saveUserAccount(user) {
            const existingUserIndex = userAccounts.findIndex(acc => acc.email === user.email);
            if (existingUserIndex !== -1) {
                userAccounts[existingUserIndex] = user;
            } else {
                userAccounts.push(user);
            }
            localStorage.setItem(USER_ACCOUNTS_KEY, JSON.stringify(userAccounts));
        }

        // NEW: Update user account
        function updateUserAccount(user) {
            saveUserAccount(user);
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
        }

        // NEW: Find user by email
        function findUserByEmail(email) {
            return userAccounts.find(user => user.email === email);
        }

        // NEW: Find user by username
        function findUserByUsername(username) {
            return userAccounts.find(user => user.username === username);
        }

        // ... existing functions ...

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing event listeners ...

            // Login form submission - ENHANCED
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                // NEW: Find user by username
                const user = findUserByUsername(username);
                
                if (user && user.password === password) {
                    currentUser = user;
                    localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                    showApp();
                    showWelcome();
                } else {
                    alert('Invalid username or password');
                }
            });
            
            // Signup form submission - ENHANCED
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const username = document.getElementById('signup-username').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                // NEW: Validate inputs
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                if (!email || !username || !password) {
                    alert('Please fill all fields');
                    return;
                }
                
                // NEW: Check if username is available
                if (!isUsernameAvailable(username)) {
                    alert('Username already taken');
                    return;
                }
                
                // NEW: Check if email already registered
                if (findUserByEmail(email)) {
                    alert('Email already registered');
                    return;
                }
                
                // NEW: Create user object
                const newUser = {
                    email,
                    username,
                    password,
                    isNew: true,
                    createdAt: new Date().toISOString()
                };
                
                // NEW: Save user to database
                userAccounts.push(newUser);
                saveUserAccount(newUser);
                
                currentUser = newUser;
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                showApp();
                showWelcome();
            });
            
            // Forgot password form submission - ENHANCED
            forgotPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('reset-email').value.trim();
                
                if (!email) {
                    document.getElementById('reset-email-error').style.display = 'block';
                    return;
                }
                
                // NEW: Check if email is registered
                const user = findUserByEmail(email);
                if (!user) {
                    document.getElementById('reset-email-error').textContent = 'Email not registered';
                    document.getElementById('reset-email-error').style.display = 'block';
                    return;
                }
                
                // NEW: Store reset email for later
                resetEmail = email;
                
                generateAndStoreOTP(email);
                showForm('otp-form');
            });
            
            // Generate and store OTP
            function generateAndStoreOTP(email) {
                const otp = generateOTP();
                localStorage.setItem('insightAtlasOTP', otp);
                localStorage.setItem('insightAtlasOTPEmail', email);
                localStorage.setItem('insightAtlasOTPTime', Date.now());
                displayOTP(otp);
            }
            
            // OTP form submission - ENHANCED
            otpForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const otpInputs = document.querySelectorAll('.otp-input');
                let otpValue = '';
                otpInputs.forEach(input => {
                    otpValue += input.value;
                });
                
                const storedOTP = localStorage.getItem('insightAtlasOTP');
                const storedEmail = localStorage.getItem('insightAtlasOTPEmail');
                
                // NEW: Verify OTP
                if (otpValue === storedOTP && resetEmail === storedEmail) {
                    showForm('reset-password-form');
                } else {
                    document.getElementById('otp-error').style.display = 'block';
                }
            });
            
            // Reset password form submission - ENHANCED
            resetPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                
                if (newPassword !== confirmPassword) {
                    document.getElementById('confirm-new-password-error').style.display = 'block';
                    return;
                }
                
                // NEW: Find user and update password
                const user = findUserByEmail(resetEmail);
                if (user) {
                    user.password = newPassword;
                    saveUserAccount(user);
                    alert('Password reset successfully');
                    showForm('login-form');
                    
                    // Clear reset state
                    resetEmail = '';
                } else {
                    alert('User not found');
                }
            });
            
            // ... rest of the code ...
        });
    </script>
</body>
</html>
